<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>School of Rock – HubSpot Forms & Contact-Centric Architecture</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #0b0c10;
      --bg-elevated: #101118;
      --bg-soft: #14151f;
      --accent: #e92b2d;
      --accent-soft: rgba(233, 43, 45, 0.2);
      --accent-2: #ff6b7a;
      --text: #f8fafc;
      --muted: #aeb6c1;
      --border-subtle: #1f222b;
      --danger: #f25f6b;
      --radius-lg: 18px;
      --radius-pill: 999px;
      --shadow-soft: 0 18px 45px rgba(15, 23, 42, 0.75);
      scroll-behavior: smooth;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      padding: 0;
      font-family: "Inter", "Segoe UI", system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text", sans-serif;
      background: radial-gradient(circle at 18% 18%, rgba(233, 43, 45, 0.18), transparent 32%), radial-gradient(circle at 82% 20%, rgba(122, 30, 216, 0.16), transparent 26%), linear-gradient(180deg, #0b0c10 0%, #0f1119 42%, #0b0c10 100%);
      color: var(--text);
      font-size: 16px;
      line-height: 1.6;
    }

    .page {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    header {
      position: sticky;
      top: 0;
      z-index: 10;
      backdrop-filter: blur(18px);
      background: linear-gradient(to bottom, rgba(3, 7, 18, 0.95), rgba(3, 7, 18, 0.7));
      border-bottom: 1px solid rgba(15, 23, 42, 0.8);
    }

    .nav-inner {
      max-width: 1280px;
      margin: 0 auto;
      padding: 0.8rem 1.6rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 1rem;
      border-top: 1px solid rgba(59, 72, 95, 0.35);
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    .brand-mark {
      width: 32px;
      height: 32px;
      border-radius: 10px;
      background: conic-gradient(from 180deg, #d81e2d, #f25f6b, #6b46c1, #d81e2d);
      padding: 2px;
      box-shadow: 0 10px 30px rgba(216, 30, 45, 0.45);
    }

    .brand-mark-inner {
      width: 100%;
      height: 100%;
      border-radius: 8px;
      background: radial-gradient(circle at 30% 20%, rgba(248, 250, 252, 0.2), transparent 55%), #020617;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.8rem;
      color: #f25f6b;
      font-weight: 700;
    }

    .brand-text {
      display: flex;
      flex-direction: column;
      gap: 0.1rem;
    }

    .brand-name {
      font-weight: 600;
      letter-spacing: 0.04em;
      font-size: 0.9rem;
      text-transform: uppercase;
    }

    .brand-sub {
      font-size: 0.78rem;
      color: var(--muted);
    }

    .nav-links {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      font-size: 0.86rem;
    }

    .nav-links a {
      padding: 0.35rem 0.7rem;
      border-radius: 999px;
      border: 1px solid transparent;
      color: var(--muted);
      text-decoration: none;
      transition: all 0.16s ease-out;
      white-space: nowrap;
    }

    .nav-links a:hover {
      color: var(--text);
      border-color: rgba(148, 163, 184, 0.5);
      background: rgba(15, 23, 42, 0.85);
    }

    .nav-links a.primary {
      border-color: rgba(216, 30, 45, 0.55);
      background: radial-gradient(circle at top left, rgba(216, 30, 45, 0.32), rgba(15, 23, 42, 0.95));
      color: #fde8eb;
    }

    main {
      flex: 1;
    }

    .wrapper {
      max-width: 1280px;
      margin: 0 auto;
      padding: 1.7rem 1.6rem 2.9rem;
    }

    /* Hero */
    .hero {
      display: grid;
      grid-template-columns: minmax(0, 2.1fr) minmax(0, 1.8fr);
      gap: 1.4rem;
      align-items: center;
      margin-top: 0.8rem;
      margin-bottom: 2.25rem;
    }

    @media (max-width: 860px) {
      .hero {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    .hero-left {
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

    .eyebrow {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.25rem 0.6rem;
      border-radius: var(--radius-pill);
      background: rgba(15, 23, 42, 0.9);
      border: 1px solid rgba(55, 65, 81, 0.9);
      font-size: 0.78rem;
      color: var(--muted);
    }

    .eyebrow-pill {
      padding: 0.15rem 0.5rem;
      border-radius: 999px;
      background: var(--accent-soft);
      color: #fde8eb;
      font-size: 0.74rem;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      font-weight: 600;
    }

    h1 {
      font-size: clamp(1.9rem, 3vw, 2.4rem);
      line-height: 1.12;
      margin: 0;
      letter-spacing: 0.01em;
    }

    .hero-sub {
      color: var(--text);
      font-size: 1.02rem;
      max-width: 38rem;
    }

    .hero-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 0.4rem;
      margin-top: 0.4rem;
    }

    .tag {
      padding: 0.25rem 0.6rem;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.9);
      border: 1px solid rgba(31, 41, 55, 0.9);
      font-size: 0.72rem;
      color: var(--muted);
    }

    .hero-meta {
      display: flex;
      flex-wrap: wrap;
      gap: 1.25rem;
      margin-top: 0.8rem;
      font-size: 0.85rem;
      color: var(--muted);
    }

    .hero-meta span strong {
      color: var(--text);
      font-weight: 600;
    }

    .hero-right {
      position: relative;
    }

    .hero-card {
      position: relative;
      background: radial-gradient(circle at top, rgba(216, 30, 45, 0.12), transparent 60%), linear-gradient(145deg, #0f1119, #0f1119 40%, #0b0c10 100%);
      border-radius: 24px;
      padding: 1.3rem 1.3rem 1rem;
      border: 1px solid rgba(59, 72, 95, 0.85);
      box-shadow: var(--shadow-soft);
      overflow: hidden;
    }

    .hero-card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.9rem;
    }

    .hero-card-title {
      font-size: 0.9rem;
      font-weight: 600;
    }

    .hero-pill {
      padding: 0.2rem 0.7rem;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.9);
      border: 1px solid rgba(55, 65, 81, 0.9);
      font-size: 0.72rem;
      color: var(--muted);
    }

    .hero-grid {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 0.45rem;
      font-size: 0.8rem;
    }

    .hero-chip {
      border-radius: 999px;
      padding: 0.35rem 0.55rem;
      border: 1px solid rgba(51, 65, 85, 0.9);
      background: rgba(15, 23, 42, 0.9);
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 0.3rem;
      color: var(--muted);
    }

    .hero-chip span {
      font-size: 0.7rem;
    }

    .hero-chip strong {
      font-size: 0.78rem;
      color: var(--accent-2);
      font-weight: 600;
    }

    .hero-footer {
      margin-top: 0.9rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 0.82rem;
      color: var(--muted);
    }

    .hero-status-dot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: var(--accent);
      box-shadow: 0 0 0 6px rgba(233, 43, 45, 0.18);
      margin-right: 0.4rem;
    }

    /* Sections */
    section {
      margin-bottom: 2.4rem;
      scroll-margin-top: 96px;
    }

    section h2 {
      font-size: 1.32rem;
      margin: 0 0 0.75rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    section h2 span.badge {
      font-size: 0.7rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      padding: 0.15rem 0.5rem;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.95);
      border: 1px solid rgba(55, 65, 81, 0.9);
      color: var(--muted);
    }

    section p {
      margin: 0 0 0.75rem;
      font-size: 0.98rem;
      color: var(--muted);
      text-align: left;
    }

    .grid-2 {
      display: grid;
      grid-template-columns: minmax(0, 1.4fr) minmax(0, 1fr);
      gap: 1.4rem;
    }

    @media (max-width: 900px) {
      .grid-2 {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    .card {
      background: linear-gradient(140deg, rgba(16, 18, 24, 0.98), rgba(14, 16, 22, 0.94));
      border-radius: var(--radius-lg);
      border: 1px solid rgba(59, 72, 95, 0.8);
      padding: 1.1rem 1.15rem 1rem;
      box-shadow: 0 20px 60px rgba(6, 11, 25, 0.72);
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.6rem;
    }

    .card-title {
      font-size: 1rem;
      font-weight: 650;
      color: var(--text);
    }

    .pill {
      font-size: 0.7rem;
      padding: 0.2rem 0.6rem;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.96);
      border: 1px solid rgba(51, 65, 85, 0.95);
      color: var(--muted);
      letter-spacing: 0.01em;
    }

    .list {
      list-style: none;
      padding: 0;
      margin: 0;
      font-size: 0.94rem;
      color: var(--muted);
      text-align: left;
    }

    .list li {
      padding: 0.25rem 0;
      display: flex;
      gap: 0.45rem;
      align-items: flex-start;
    }

    .list li::before {
      content: "";
      margin-top: 0.4rem;
      width: 5px;
      height: 5px;
      border-radius: 999px;
      background: rgba(226, 232, 240, 0.9);
      flex-shrink: 0;
    }

    .list strong {
      color: var(--text);
      font-weight: 600;
      display: inline-block;
      min-width: 160px;
      max-width: 210px;
    }

    @media (max-width: 720px) {
      .list strong {
        min-width: 140px;
        max-width: 190px;
      }
    }

    .pill-row {
      display: flex;
      flex-wrap: wrap;
      gap: 0.4rem;
      margin-top: 0.35rem;
    }

    .pill-row span {
      font-size: 0.72rem;
      padding: 0.2rem 0.55rem;
      border-radius: 999px;
      border: 1px solid rgba(59, 72, 95, 0.8);
      background: rgba(15, 23, 42, 0.96);
      color: var(--muted);
    }

    .pill-row span.positive {
      border-color: rgba(216, 30, 45, 0.45);
      background: rgba(216, 30, 45, 0.16);
      color: #f8d7dd;
    }

    .pill-row span.risk {
      border-color: rgba(248, 113, 113, 0.45);
      background: rgba(248, 113, 113, 0.16);
      color: #fcdedf;
    }

    .table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 0.6rem;
      font-size: 0.86rem;
    }

    .table th,
    .table td {
      padding: 0.45rem 0.6rem;
      border-bottom: 1px solid rgba(31, 41, 55, 0.9);
    }

    .table th {
      text-align: left;
      font-weight: 600;
      color: var(--muted);
    }

    .table td.code {
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 0.82rem;
      color: #f8fafc;
    }

    .code-block {
      margin-top: 0.5rem;
      padding: 0.6rem 0.7rem;
      background: #020617;
      border-radius: 12px;
      border: 1px solid rgba(30, 64, 175, 0.85);
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 0.82rem;
      color: #f8fafc;
      overflow-x: auto;
      max-height: 300px;
      white-space: pre;
    }

    .diagram {
      margin-top: 0.5rem;
      padding: 0.85rem 0.9rem;
      background: #0d101b;
      border-radius: 14px;
      border: 1px solid rgba(59, 72, 95, 0.9);
      box-shadow: var(--shadow-soft);
      overflow-x: auto;
      max-height: 220px;
    }

    .diagram-toggle {
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
      padding: 0.38rem 0.75rem;
      border-radius: 999px;
      border: 1px solid rgba(55, 65, 81, 0.95);
      background: rgba(15, 23, 42, 0.9);
      color: var(--muted);
      font-size: 0.78rem;
      cursor: pointer;
      transition: all 0.15s ease-out;
    }

    .diagram-toggle:hover {
      color: var(--text);
      border-color: rgba(233, 43, 45, 0.55);
      background: rgba(233, 43, 45, 0.16);
    }

    .diagram-toggle .dot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: #d81e2d;
      box-shadow: 0 0 0 6px rgba(216, 30, 45, 0.18);
    }

    .diagram-note {
      font-size: 0.76rem;
      color: var(--muted);
      margin: 0.25rem 0 0.35rem;
    }

    .diagram-modal {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.65);
      backdrop-filter: blur(8px);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }

    .diagram-modal.active {
      display: flex;
    }

    .diagram-modal-content {
      background: #0b1020;
      border: 1px solid rgba(59, 72, 95, 0.95);
      border-radius: 16px;
      width: min(1200px, 92vw);
      height: min(780px, 88vh);
      box-shadow: 0 24px 70px rgba(0, 0, 0, 0.45);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .diagram-modal-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0.65rem 0.9rem;
      border-bottom: 1px solid rgba(59, 72, 95, 0.8);
      background: rgba(15, 23, 42, 0.8);
    }

    .diagram-modal-title {
      font-size: 0.92rem;
      color: var(--text);
    }

    .diagram-controls {
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
    }

    .diagram-btn {
      border: 1px solid rgba(59, 72, 95, 0.9);
      background: rgba(15, 23, 42, 0.9);
      color: var(--muted);
      border-radius: 10px;
      padding: 0.35rem 0.65rem;
      cursor: pointer;
      font-size: 0.8rem;
      transition: all 0.15s ease-out;
    }

    .diagram-btn:hover {
      color: var(--text);
      border-color: rgba(233, 43, 45, 0.55);
    }

    .diagram-modal-body {
      flex: 1;
      position: relative;
      background: radial-gradient(circle at 18% 20%, rgba(233, 43, 45, 0.12), transparent 35%), #050816;
      overflow: hidden;
    }

    .diagram-viewer {
      position: absolute;
      inset: 0;
      cursor: grab;
    }

    .diagram-viewer:active {
      cursor: grabbing;
    }

    .diagram-viewer-inner {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%) scale(1);
      transform-origin: center center;
      transition: transform 0.15s ease-out;
    }

    .diagram-viewer-inner.no-transition {
      transition: none;
    }

    .zoom-indicator {
      position: absolute;
      bottom: 1rem;
      left: 1rem;
      padding: 0.35rem 0.7rem;
      border-radius: 8px;
      background: rgba(15, 23, 42, 0.9);
      border: 1px solid rgba(59, 72, 95, 0.8);
      font-size: 0.75rem;
      color: var(--muted);
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
    }

    .zoom-indicator strong {
      color: var(--text);
    }

    .diagram-help {
      position: absolute;
      bottom: 1rem;
      right: 1rem;
      padding: 0.35rem 0.7rem;
      border-radius: 8px;
      background: rgba(15, 23, 42, 0.9);
      border: 1px solid rgba(59, 72, 95, 0.8);
      font-size: 0.72rem;
      color: var(--muted);
      display: flex;
      gap: 1rem;
    }

    .diagram-help span {
      display: flex;
      align-items: center;
      gap: 0.3rem;
    }

    .diagram-help kbd {
      padding: 0.1rem 0.35rem;
      border-radius: 4px;
      background: rgba(51, 65, 85, 0.6);
      border: 1px solid rgba(71, 85, 105, 0.8);
      font-size: 0.68rem;
      font-family: inherit;
    }

    .diagram-controls {
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
    }

    .diagram-controls .zoom-slider {
      width: 80px;
      height: 4px;
      -webkit-appearance: none;
      appearance: none;
      background: rgba(51, 65, 85, 0.8);
      border-radius: 2px;
      outline: none;
      margin: 0 0.5rem;
    }

    .diagram-controls .zoom-slider::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 14px;
      height: 14px;
      border-radius: 50%;
      background: var(--accent);
      cursor: pointer;
      border: 2px solid rgba(255, 255, 255, 0.2);
    }

    .diagram-controls .zoom-slider::-moz-range-thumb {
      width: 14px;
      height: 14px;
      border-radius: 50%;
      background: var(--accent);
      cursor: pointer;
      border: 2px solid rgba(255, 255, 255, 0.2);
    }

    .code-label {
      font-size: 0.72rem;
      color: var(--muted);
      margin-bottom: 0.25rem;
    }

    .badge-row {
      display: flex;
      flex-wrap: wrap;
      gap: 0.35rem;
      margin-top: 0.35rem;
      font-size: 0.74rem;
    }

    .badge-row span {
      padding: 0.18rem 0.55rem;
      border-radius: 999px;
      border: 1px solid rgba(55, 65, 81, 0.95);
      background: rgba(15, 23, 42, 0.96);
      color: var(--muted);
      font-weight: 600;
    }

    .badge-row span.key {
      border-color: rgba(233, 43, 45, 0.7);
      background: rgba(233, 43, 45, 0.16);
      color: #fde8eb;
    }

    .timeline {
      position: relative;
      padding-left: 1rem;
      margin-top: 0.5rem;
    }

    .timeline::before {
      content: "";
      position: absolute;
      left: 0.3rem;
      top: 0.2rem;
      bottom: 0.2rem;
      width: 2px;
      background: linear-gradient(to bottom, rgba(51, 65, 85, 0.9), rgba(15, 23, 42, 0.5));
    }

    .timeline-step {
      position: relative;
      padding-left: 0.7rem;
      margin-bottom: 0.55rem;
      font-size: 0.92rem;
      color: var(--muted);
    }

    .timeline-step::before {
      content: "";
      position: absolute;
      left: -0.03rem;
      top: 0.2rem;
      width: 9px;
      height: 9px;
      border-radius: 999px;
      border: 2px solid rgba(148, 163, 184, 1);
      background: #020617;
    }

    .timeline-step strong {
      color: var(--text);
      font-weight: 500;
    }

    footer {
      border-top: 1px solid rgba(15, 23, 42, 0.9);
      padding: 0.9rem 1.25rem 1.2rem;
      color: var(--muted);
      font-size: 0.78rem;
    }

    footer .footer-inner {
      max-width: 1280px;
      margin: 0 auto;
      display: flex;
      justify-content: space-between;
      gap: 1rem;
      flex-wrap: wrap;
      align-items: center;
    }
  </style>
</head>
<body>
  <div class="page">
    <header>
      <div class="nav-inner">
        <div class="brand">
          <div class="brand-mark">
            <div class="brand-mark-inner">SoR</div>
          </div>
          <div class="brand-text">
            <div class="brand-name">HubSpot Forms Architecture</div>
            <div class="brand-sub">School of Rock · Contact-first CRM & Bridge Integration</div>
          </div>
        </div>
        <nav class="nav-links">
          <a href="#scope">Scope</a>
          <a href="#commercial">Commercial</a>
          <a href="#architecture">Architecture</a>
          <a href="#data-model">Data Model</a>
          <a href="#flows">Flows</a>
          <a href="#implementation">Implementation</a>
          <a href="#proposed-decisions">Decisions</a>
          <a href="#risks" class="primary">Risks & Open Items</a>
        </nav>
      </div>
    </header>

    <main>
      <div class="wrapper">
        <!-- HERO -->
        <section class="hero" id="top">
          <div class="hero-left">
            <div class="eyebrow">
              <span class="eyebrow-pill">Discovery & CRM Architecture</span>
              <span>From iframe forms → HubSpot forms → Contact-first model</span>
            </div>
            <h1>
              School of Rock – HubSpot Forms & Contact-Centric Lead Management
            </h1>
            <p class="hero-sub">
              This page summarizes the Metajive discovery scope, the target HubSpot architecture, and the
              end-to-end data flows between HubSpot, Bridge, and Pike13. It is designed as a living reference for
              marketing, CRM, product, and engineering teams.
            </p>
            <div class="hero-tags">
              <span class="tag">Single HubSpot portal · Franchise users</span>
              <span class="tag">Contact-first lifecycle</span>
              <span class="tag">Bridge → Pike13 sync</span>
              <span class="tag">Multi-owner routing</span>
            </div>
            <div class="hero-meta">
              <span><strong>Client:</strong> School of Rock (YEB)</span>
              <span><strong>Partner:</strong> Metajive</span>
              <span><strong>Timeframe (Discovery):</strong> Dec 8, 2025 – Jan 30, 2026</span>
            </div>
          </div>

          <div class="hero-right">
            <div class="hero-card">
              <div class="hero-card-header">
                <div class="hero-card-title">System Snapshot</div>
                <div class="hero-pill">Contact → Bridge → Pike13</div>
              </div>
              <div class="hero-grid">
                <div class="hero-chip">
                  <span>Primary object</span>
                  <strong>Contact</strong>
                </div>
                <div class="hero-chip">
                  <span>Lead routing</span>
                  <strong>Location-based</strong>
                </div>
                <div class="hero-chip">
                  <span>Owners</span>
                  <strong>Multi-user</strong>
                </div>
                <div class="hero-chip">
                  <span>Forms</span>
                  <strong>HubSpot-native</strong>
                </div>
                <div class="hero-chip">
                  <span>Sync</span>
                  <strong>2-way (key fields)</strong>
                </div>
                <div class="hero-chip">
                  <span>Deals</span>
                  <strong>Trigger-based</strong>
                </div>
              </div>
              <div class="hero-footer">
                <div style="display:flex;align-items:center;gap:0.3rem;">
                  <span class="hero-status-dot"></span>
                  <span>Discovery-ready – implementation follows SOW output. (SOW details may change based on discovery findings)</span>
                </div>
                <span>Audience: Marketing · CRM · Product · Dev</span>
              </div>
            </div>
          </div>
        </section>

        <!-- SCOPE & GOALS -->
        <section id="scope">
          <h2>
            Scope & Goals
            <span class="badge">From SOW & SoR requirements</span>
          </h2>
          <div class="grid-2">
            <div class="card">
              <div class="card-header">
                <div class="card-title">Metajive Discovery Scope (Summary)</div>
                <div class="pill">Time & Materials · 40 hrs (max)</div>
              </div>
              <ul class="list">
                <li>Assess transition from iframe-based forms to HubSpot-native forms for School of Rock (move fully onto HubSpot native forms).</li>
                <li>Understand technical implications for the website and the Bridge layer into Pike13.</li>
                <li>Support stakeholder meetings and documentation of risks, scenarios, and approaches.</li>
                <li>Produce a future implementation SOW outlining technical approach and effort.</li>
              </ul>
              <div class="pill-row">
                <span class="positive">Discovery only</span>
                <span>Implementation of CRM strategy is out of scope</span>
                <span>API / integration build is out of scope</span>
                <span>HubSpot license changes out of scope</span>
                <span>Data migration out of scope</span>
                <span>User training out of scope</span>
              </div>
            </div>

            <div class="card">
              <div class="card-header">
                <div class="card-title">SoR CRM Objectives</div>
                <div class="pill">Contact-first · Franchise users</div>
              </div>
              <ul class="list">
                <li><strong>Move from Deal-first → Contact-first:</strong> franchise users primarily work leads from the Contact record.</li>
                <li><strong>Use HubSpot forms:</strong> all public forms submit into HubSpot with a required Location field.</li>
                <li><strong>Multi-owner support:</strong> each Contact can be owned by multiple users via a dedicated multi-user property.</li>
                <li><strong>Bridge & Pike13 alignment:</strong> Bridge creates/links Pike13 contacts and deals based on HubSpot data and Location. <em>Note: OpsHub works at Contact/Customer level only; syncs to one account. Bridge handles school routing.</em></li>
              </ul>
              <div class="pill-row">
                <span class="positive">Respect Single Portal + Many Locations</span>
                <span class="positive">Avoid duplicate Contacts and Deals</span>
                <span class="risk">Avoid lifecycle moving backwards</span>
              </div>
            </div>
          </div>
        </section>

        <!-- COMMERCIAL -->
        <section id="commercial">
          <h2>
            Commercial Terms
            <span class="badge">Discovery engagement</span>
          </h2>
          <div class="card">
            <div class="card-header">
              <div class="card-title">Engagement Details</div>
              <div class="pill">Time & Materials</div>
            </div>
            <ul class="list">
              <li><strong>Structure:</strong> Time & Materials (T&M)</li>
              <li><strong>Cap:</strong> 40 hours maximum</li>
              <li><strong>Rate:</strong> As per existing Metajive MSA</li>
              <li><strong>Deliverable:</strong> Implementation SOW with technical approach and effort estimates</li>
            </ul>
          </div>
        </section>

        <!-- RESPONSIBILITIES -->
        <section id="responsibilities">
          <h2>
            Responsibilities
            <span class="badge">RACI overview</span>
          </h2>
          <div class="grid-2">
            <div class="card">
              <div class="card-header">
                <div class="card-title">Metajive (Partner)</div>
                <div class="pill">Discovery lead</div>
              </div>
              <ul class="list">
                <li>Lead discovery sessions and stakeholder meetings</li>
                <li>Document technical scenarios and risks</li>
                <li>Produce implementation SOW</li>
                <li>Provide HubSpot and integration expertise</li>
              </ul>
            </div>
            <div class="card">
              <div class="card-header">
                <div class="card-title">School of Rock (Client)</div>
                <div class="pill">Business owner</div>
              </div>
              <ul class="list">
                <li>Provide access to HubSpot portal and Bridge documentation</li>
                <li>Participate in discovery sessions</li>
                <li>Confirm business requirements and decisions</li>
                <li>Review and approve deliverables</li>
              </ul>
            </div>
          </div>
        </section>

        <!-- ARCHITECTURE OVERVIEW -->
        <section id="architecture">
          <h2>
            Target Architecture
            <span class="badge">Contact-centric · Location-aware · Bridge-integrated</span>
          </h2>
          <div class="grid-2">
            <div class="card">
              <div class="card-header">
                <div class="card-title">High-Level Design</div>
                <div class="pill">Core principles</div>
              </div>
              <ul class="list">
                <li><strong>Contacts as source of truth:</strong> lifecycle, ownership, and location context live on the Contact.</li>
                <li><strong>Deals are derived, not primary:</strong> created only when specific triggers occur (trial, enrollment, etc.).</li>
                <li><strong>Location drives routing:</strong> every form submission includes a Location; routing and ownership rules use it as the anchor.</li>
                <li><strong>Multi-owner model:</strong> a single multi-user property tracks all relevant owners by location.</li>
                <li><strong>Automation directive field:</strong> a hidden text field encodes "what should happen next" for workflows and Bridge.</li>
              </ul>
            </div>
            <div class="card">
              <div class="card-header">
                <div class="card-title">System Interaction</div>
                <div class="pill">Web → HubSpot → Bridge → Pike13</div>
              </div>
              <ul class="list">
                <li><strong>Form → HubSpot:</strong> user submits HubSpot form; Location captured.</li>
                <li><strong>Contact is updated:</strong> ownership and lifecycle directive set on the Contact.</li>
                <li><strong>Tasks/Deals fire:</strong> workflows create tasks and optional deals per directive.</li>
                <li><strong>Bridge handoff:</strong> payload sent to Bridge with contact/deal + Location.</li>
                <li><strong>Pike13 sync:</strong> Bridge creates/links Pike13 records and returns IDs/status to HubSpot.</li>
              </ul>
            </div>
          </div>
        </section>

        <!-- DATA MODEL -->
        <section id="data-model">
          <h2>
            Data Model & Key Properties
            <span class="badge">Contacts · Deals · Location & Ownership</span>
          </h2>
          <div class="grid-2">
            <div class="card">
              <div class="card-header">
                <div class="card-title">Contact Properties</div>
                <div class="pill">Routing, ownership, lifecycle</div>
              </div>
              <table class="table">
                <thead>
                  <tr>
                    <th>Label</th>
                    <th>Internal Name</th>
                    <th>Type</th>
                    <th>Notes</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td>Multi form owner</td>
                    <td class="code">multi_form_owner</td>
                    <td>User (multi-select)</td>
                    <td>Holds all owners per Contact across locations; used for task/alert routing.</td>
                  </tr>
                  <tr>
                    <td>Location</td>
                    <td class="code">location</td>
                    <td>Multi-select</td>
                    <td>Captured from HubSpot forms; format <code>[location name]+[school id]+[order added]</code> (e.g., <code>Fayetteville521_01</code>). Drives routing, Bridge handles school-specific logic. Data dictionary required for field mapping.</td>
                  </tr>
                  <tr>
                    <td>School location lifecycle details</td>
                    <td class="code">school_location_lifecycle_details</td>
                    <td>Single-line text</td>
                    <td>Encoded automation directive (lifecycle, alert, pipeline, location).</td>
                  </tr>
                  <tr>
                    <td>Pike13 Contact ID(s)</td>
                    <td class="code">hs_object_id</td>
                    <td>Text</td>
                    <td>Use HubSpot <code>hs_object_id</code> as temporary anchor until a dedicated Pike13 ID field is defined.</td>
                  </tr>
                </tbody>
              </table>
              <div class="badge-row">
                <span class="key">Contacts = single canonical profile</span>
                <span>Location determines routing for each submission</span>
                <span>Owners are appended per location, not overwritten</span>
              </div>
            </div>

            <div class="card">
              <div class="card-header">
                <div class="card-title">Automation Directive Format</div>
                <div class="pill">School location lifecycle details</div>
              </div>
              <p class="code-label">Recommended encoding:</p>
              <div class="code-block">
loc=Fayetteville521_01; lifecycle=LEAD; alert=new_lead; pipeline=TRIAL
loc=Boulder123_02; lifecycle=MQL; alert=trial_followup; pipeline=ENROLLMENT
              </div>
              <p>
                This single-line field is populated by workflows and read by other workflows (and Bridge) to determine
                what should happen next: which task to create (same alert set across locations), whether to create a Deal,
                how to adjust lifecycle, and which pipeline to use. Current direction: handle early lead state on the Contact; an optional lightweight 3-stage Lead deal pipeline can be added later if needed.
              </p>
              <div class="badge-row">
                <span class="key">Set by automation only</span>
                <span>Human-readable and machine-parseable</span>
                <span>Safe to extend with new keys over time</span>
              </div>
            </div>
          </div>
        </section>

        <!-- FLOWS & DIAGRAMS -->
        <section id="flows">
          <h2>
            Key Flows & Diagrams
            <span class="badge">Mermaid-ready · System & user perspectives</span>
          </h2>

          <div class="card" style="margin-bottom:1.4rem;">
            <div class="card-header">
              <div class="card-title">End-to-End Flow: Form → Contact → Tasks/Deals → Bridge → Pike13</div>
              <div class="pill">Technical view</div>
            </div>
            <div class="diagram-note" style="margin-bottom:0.4rem;">Preview below · Open for zoom/pan</div>
            <button class="diagram-toggle diagram-open" data-target="diagram-endtoend" data-title="End-to-End Flow">
              <span class="dot"></span>
              <span>Open in modal</span>
            </button>
            <div class="diagram mermaid" id="diagram-endtoend">
flowchart LR
    subgraph UserSide["User/Website/BAT/SoR"]
        F1["Form submission<br/>Location selected"]
    end

    subgraph HubSpot["HubSpot"]
        D1{"Contact exists?"}
        CNew["Create contact"]
        CUpd["Update contact"]

        LStage["Set/keep lifecycle stage"]
        Loc["Set/update location"]
        Owners["Update multi_form_owner<br/>(location-based owners)"]
        Meta["Set lifecycle details<br/>(loc=..; lifecycle=..; alert=..; pipeline=..)"]

        subgraph Tasks["Task automation"]
            TNew["Create new lead task"]
            TExist["Create existing lead follow-up task"]
            TTrial["Create trial confirmation task"]
            TEnroll["Create enrollment task"]
            TDone["Task completed"]
            TUpdate["Update lifecycle & details"]
        end

        subgraph Deals["Deal automation"]
            DTrig{"Deal trigger?"}
            DCreate["Create trial/enrollment deal"]
        end
    end

    subgraph Bridge["Bridge service"]
        BSend["Send contact/deal payload<br/>to Bridge"]
        BCheck["Bridge checks Pike13<br/>(email + location)"]
        BCreateC["Create Pike13 contact<br/>if none exists"]
        BCreateD["Create/update Pike13 deal"]
        BSyncBack["Sync Pike13 IDs/status<br/>back to HubSpot"]
    end

    subgraph Pike13["Pike13"]
        PContact["Pike13 contact<br/>(per location)"]
        PDeal["Pike13 deal<br/>(trial / enrollment)"]
    end

    F1 --> D1
    D1 -- "No" --> CNew
    CNew --> LStage
    CNew --> Loc
    Loc --> Owners
    Owners --> Meta
    Meta --> BSend

    D1 -- "Yes" --> CUpd
    CUpd --> LStage
    CUpd --> Loc
    Loc --> Owners
    Owners --> Meta
    Meta --> BSend

    BSend --> BCheck
    BCheck -->|No match| BCreateC --> PContact
    BCheck -->|Existing| PContact

    BSend --> BCreateD --> PDeal
    PContact --> BSyncBack
    PDeal --> BSyncBack
    BSyncBack --> Meta

    Meta -->|"alert=new_lead"| TNew
    Meta -->|"alert=existing_lead"| TExist
    Meta -->|"alert=trial_followup"| TTrial
    Meta -->|"alert=enrollment_followup"| TEnroll

    TNew --> TDone
    TExist --> TDone
    TTrial --> TDone
    TEnroll --> TDone
    TDone --> TUpdate
    TUpdate --> Meta

    Meta --> DTrig
    DTrig -- "Yes" --> DCreate --> BSend
    DTrig -- "No" --> Meta
            </div>
          </div>

          <div class="grid-2">
            <div class="card">
              <div class="card-header">
                <div class="card-title">Franchise User POV</div>
                <div class="pill">"What happens when a lead comes in?"</div>
              </div>
              <div class="diagram-note" style="margin-bottom:0.4rem;">Preview below · Open for zoom/pan</div>
              <button class="diagram-toggle diagram-open" data-target="diagram-franchise" data-title="Franchise User POV">
                <span class="dot"></span>
                <span>Open in modal</span>
              </button>
              <div class="diagram mermaid" id="diagram-franchise" style="max-height:260px;">
flowchart TD
    subgraph HS["HubSpot"]
        FS["Form submitted<br/>with location"]
        Cx["Contact (new or existing)"]
        OwProp["multi_form_owner updated<br/>for that location"]
        Meta["School location lifecycle details<br/>(alert + lifecycle + pipeline)"]
        Task{"Which task type?"}
        TLead["Task: New lead"]
        TFollow["Task: Lead follow-up"]
        TTrial["Task: Trial confirmation"]
        TEnroll["Task: Enrollment"]
        TAssigned["Task assigned to franchise user"]
        TDone["Task completed"]
        LUpdate["Lifecycle & details updated"]
        DTrig{"Deal triggered?"}
        DCreate["Deal created<br/>(trial/enrollment)"]
    end

    subgraph Franchise["Franchise user"]
        ViewTasks["Views tasks in HubSpot"]
        Call["Calls/emails lead"]
        BookTrial["Books trial / enrollment"]
        CompleteTask["Marks task complete"]
    end

    FS --> Cx
    Cx --> OwProp --> Meta --> Task

    Task -->|new_lead| TLead
    Task -->|existing_lead| TFollow
    Task -->|trial_followup| TTrial
    Task -->|enrollment_followup| TEnroll

    TLead --> TAssigned
    TFollow --> TAssigned
    TTrial --> TAssigned
    TEnroll --> TAssigned

    TAssigned --> ViewTasks --> Call --> BookTrial --> CompleteTask --> TDone
    TDone --> LUpdate --> DTrig

    DTrig -- "Yes" --> DCreate
    DTrig -- "No" --> Cx
              </div>
              <p>
                This diagram is ideal for training franchise teams: it shows that they primarily work Tasks from Contacts,
                and Deals are created automatically when trials or enrollments occur.
              </p>
            </div>

            <div class="card">
              <div class="card-header">
                <div class="card-title">System Interaction</div>
                <div class="pill">Architecture overview</div>
              </div>
              <div class="diagram-note" style="margin-bottom:0.4rem;">Preview below · Open for zoom/pan</div>
              <button class="diagram-toggle diagram-open" data-target="diagram-systems" data-title="Systems Overview">
                <span class="dot"></span>
                <span>Open in modal</span>
              </button>
              <div class="diagram mermaid" id="diagram-systems" style="max-height:260px;">
flowchart LR
    subgraph Web["Web properties"]
        Site["Website forms / BAT / SoR"]
    end

    subgraph HS["HubSpot CRM"]
        Forms["HubSpot forms"]
        Contacts["Contacts<br/>(multi_form_owner, location, lifecycle details)"]
        Deals["Deals<br/>(trial/enrollment)"]
        Tasks["Tasks & workflows"]
    end

    subgraph BR["Bridge"]
        BIngest["Ingest HubSpot payloads"]
        BLogic["Location & contact matching"]
        BToPike["Create/update Pike13 records"]
        BBack["Push IDs/status back"]
    end

    subgraph P13["Pike13"]
        PContacts["Pike13 contacts<br/>(per location)"]
        PDeals["Pike13 deals<br/>(per location)"]
    end

    Site --> Forms --> Contacts
    Contacts --> Tasks
    Contacts --> Deals

    Contacts --> BIngest
    Deals --> BIngest

    BIngest --> BLogic --> BToPike
    BToPike --> PContacts
    BToPike --> PDeals

    PContacts --> BBack
    PDeals --> BBack
    BBack --> Contacts
    BBack --> Deals
              </div>
              <p>
                Use this for technical review across engineering, Bridge, and product to align on handoff points and data
                contracts.
              </p>
            </div>
          </div>
        </section>

        <!-- IMPLEMENTATION PHASES -->
        <section id="implementation">
          <h2>
            Implementation Phases
            <span class="badge">From discovery → build → rollout</span>
          </h2>
          <div class="grid-2">
            <div class="card">
              <div class="card-header">
                <div class="card-title">Phase 1 – Foundations</div>
                <div class="pill">Data model & forms</div>
              </div>
              <ul class="list">
                <li>Create and configure Contact properties (multi_form_owner, location, lifecycle details).</li>
                <li>Finalize Location taxonomy and mapping to Bridge/Pike13 identifiers.</li>
                <li>Design and implement HubSpot forms with required Location fields.</li>
                <li>Document owner mapping per Location for routing.</li>
              </ul>
            </div>
            <div class="card">
              <div class="card-header">
                <div class="card-title">Phase 2 – Automation</div>
                <div class="pill">Workflows & tasking</div>
              </div>
              <ul class="list">
                <li>Build workflows for new vs existing Contacts on submission.</li>
                <li>Implement lifecycle directive encoding in School location lifecycle details.</li>
                <li>Configure task creation and task-completion automation.</li>
                <li>Configure deal-creation rules for trial and enrollment triggers.</li>
              </ul>
            </div>
          </div>
          <div class="grid-2" style="margin-top:1rem;">
            <div class="card">
              <div class="card-header">
                <div class="card-title">Phase 3 – Bridge & Pike13 Enhancements</div>
                <div class="pill">2-way sync</div>
              </div>
              <ul class="list">
                <li>Update Bridge to consume new payloads (Location, owners, lifecycle details).</li>
                <li>Implement Pike13 contact/deal creation based on email + Location.</li>
                <li>Implement sync-back of Pike13 IDs and status into HubSpot contacts/deals. <em>(OpsHub works at Contact/Customer level; Bridge orchestrates two-way sync)</em></li>
                <li>Define clear ownership rules when HubSpot vs Pike13 values differ.</li>
              </ul>
            </div>
            <div class="card">
              <div class="card-header">
                <div class="card-title">Phase 4 – Training & Reporting</div>
                <div class="pill">Rollout & measurement</div>
              </div>
              <ul class="list">
                <li>Train franchise users using the Franchise POV diagram and example records.</li>
                <li>Build dashboards for lead volume, response time, trial/ enrollment conversion by Location.</li>
                <li>Monitor duplicate creation, owner assignment accuracy, and lifecycle correctness.</li>
                <li>Iterate on workflows and directive encoding as new edge cases emerge.</li>
              </ul>
            </div>
          </div>
        </section>

        <!-- DISCOVERY QUESTIONS -->
        <section id="discovery-questions">
          <h2>
            Questions for Discovery
            <span class="badge">Pre/during discovery alignment</span>
          </h2>
          <div class="card">
            <div class="card-header">
              <div class="card-title">Items to lock before build</div>
              <div class="pill">Capture answers early</div>
            </div>
            <ul class="list">
              <li><strong>Location taxonomy & mapping:</strong> final single-select list, do we also need a multi-select helper, and how each value maps to Bridge/Pike13 (record owner, IDs).</li>
              <li><strong>Owner model:</strong> per-location owner roster and escalation rules; confirm multi_form_owner stays append-only and is never cleared.</li>
              <li><strong>Pike13 IDs:</strong> dedicated Contact/Deal Pike13 ID fields (per-location vs single) to replace the hs_object_id placeholder; how to append multiple IDs for cross-location contacts.</li>
              <li><strong>Bridge contract:</strong> exact payload schema (Contact + optional Deal), required fields, response (IDs/status), idempotency key (email + location?), and retry/error handling.</li>
              <li><strong>Dedupe & lead status:</strong> rules when a known contact submits again; where “lead status” lives per location line and how to prevent lifecycle regression.</li>
              <li><strong>Deal strategy:</strong> rely on Pike13/automation to create trial/enrollment deals, and whether to add the lightweight Lead pipeline (New, Waiting, Contacted, Won, Lost).</li>
              <li><strong>Forms inventory:</strong> list of public/internal forms and which should bypass lifecycle, tasks, or deals.</li>
              <li><strong>Tasking & SLA:</strong> assignment rules per location, SLAs, throttling to avoid task spam, and alerts when Bridge latency/failures occur.</li>
              <li><strong>Two-way sync scope:</strong> which Pike13 fields (if any) should sync back (status, schedule, attendance) and conflict resolution rules.</li>
              <li><strong>Cross-location handling:</strong> how Bridge selects/creates the right Pike13 record when a contact spans locations; storage pattern for multiple Pike13 IDs.</li>
            </ul>
          </div>
        </section>

        <!-- PROPOSED DECISIONS -->
        <section id="proposed-decisions">
          <h2>
            Proposed Decisions
            <span class="badge">Direction confirmed or pending</span>
          </h2>
          <div class="grid-2">
            <div class="card">
              <div class="card-header">
                <div class="card-title">Confirmed Decisions</div>
                <div class="pill">Locked in</div>
              </div>
              <ul class="list">
                <li><strong>Location field:</strong> Multi-select with format <code>[location name]+[school id]+[order added]</code> (e.g., <code>Fayetteville521_01</code>)</li>
                <li><strong>multi_form_owner:</strong> Append-only (never cleared)</li>
                <li><strong>Lifecycle handling:</strong> Use "lead status" per location line in <code>school_location_lifecycle_details</code></li>
                <li><strong>Task SLA:</strong> No formal SLA (&lt;24hr typical); no throttling needed</li>
                <li><strong>OpsHub sync:</strong> Contact/Customer level only; Bridge orchestrates two-way sync</li>
                <li><strong>Data dictionary:</strong> Required for field mapping between HubSpot, Bridge, and Pike13</li>
              </ul>
            </div>
            <div class="card">
              <div class="card-header">
                <div class="card-title">Pending Decisions</div>
                <div class="pill">To confirm during discovery</div>
              </div>
              <ul class="list">
                <li><strong>Lead pipeline:</strong> Either encode in <code>school_location_lifecycle_details</code> OR use new deal pipeline (New → Waiting → Contacted → Won → Lost)</li>
                <li><strong>Deal trigger:</strong> "Won" on HubSpot pipeline OR Pike13 conversion points (trial signup, enrollment)</li>
                <li><strong>Pike13 ID storage:</strong> Single field vs per-location (array/JSON) – TBD during discovery</li>
                <li><strong>Bridge contract:</strong> Exact payload schema, idempotency keys, retry/error handling – TBD</li>
                <li><strong>Cross-location handling:</strong> How Bridge selects/creates Pike13 record when contact spans locations</li>
              </ul>
            </div>
          </div>
        </section>

        <!-- RISKS & OPEN ITEMS -->
        <section id="risks">
          <h2>
            Risks & Open Questions
            <span class="badge">To validate during discovery</span>
          </h2>
          <div class="grid-2">
            <div class="card">
              <div class="card-header">
                <div class="card-title">Key Risks</div>
                <div class="pill">Assumptions to stress-test</div>
              </div>
              <ul class="list">
                <li><strong>Ownership ambiguity:</strong> clarity is required on how owners are mapped to locations and how conflicts will be resolved.</li>
                <li><strong>Lifecycle safety:</strong> rules must prevent unintended backwards movement (e.g., Customer → Lead).</li>
                <li><strong>Duplicate handling:</strong> consistent matching logic (email + location) is needed across HubSpot and Bridge.</li>
                <li><strong>Bridge latency/failure:</strong> workflows must gracefully handle sync delays or errors from Bridge/Pike13.</li>
                <li><strong>Task overload:</strong> automation should avoid spamming users with low-value tasks.</li>
              </ul>
            </div>
            <div class="card">
              <div class="card-header">
                <div class="card-title">Open Decisions</div>
                <div class="pill">To finalize with stakeholders</div>
              </div>
              <ul class="list">
                <li>Exact internal naming / structure for Pike13 ID properties on Contacts and Deals (Bridge currently handles its own linking logic).</li>
                <li>Definition of "internal" forms and how they should behave (no lifecycle change, limited routing, etc.).</li>
                <li>Detailed field list for 2-way synced attributes (status tags, attendance, multi-program support).</li>
                <li>Whether to add an optional lightweight 3-stage Lead deal pipeline (lead handling is Contact-only for now).</li>
                <li>Long-term handling of multi-program enrollment and cross-location membership.</li>
              </ul>
            </div>
          </div>
        </section>
      </div>
    </main>

    <footer>
      <div class="footer-inner">
        <span>
          Built as a reference page for the School of Rock HubSpot forms discovery and implementation planning.
        </span>
        <span>
          Sections can be copied into docs, slidedecks, and implementation tickets as needed.
        </span>
      </div>
    </footer>
  </div>
</body>
<div class="diagram-modal" id="diagram-modal">
  <div class="diagram-modal-content">
    <div class="diagram-modal-header">
      <div class="diagram-modal-title" id="diagram-modal-title">Diagram</div>
      <div class="diagram-controls">
        <button class="diagram-btn" id="zoom-out" title="Zoom out (-)">−</button>
        <input type="range" class="zoom-slider" id="zoom-slider" min="20" max="300" value="100" />
        <button class="diagram-btn" id="zoom-in" title="Zoom in (+)">+</button>
        <button class="diagram-btn" id="zoom-fit" title="Fit to view">Fit</button>
        <button class="diagram-btn" id="zoom-reset" title="Reset to 100%">100%</button>
        <button class="diagram-btn" id="diagram-close">Close</button>
      </div>
    </div>
    <div class="diagram-modal-body">
      <div class="diagram-viewer" id="diagram-viewer">
        <div class="diagram-viewer-inner" id="diagram-viewer-inner"></div>
      </div>
      <div class="zoom-indicator" id="zoom-indicator">Zoom: <strong>100%</strong></div>
      <div class="diagram-help">
        <span><kbd>Scroll</kbd> Zoom</span>
        <span><kbd>Drag</kbd> Pan</span>
        <span><kbd>Dbl-click</kbd> Reset</span>
      </div>
    </div>
  </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/mermaid@10.9.5/dist/mermaid.min.js"></script>
<script>
  if (window.mermaid) {
    mermaid.initialize({
      startOnLoad: true,
      theme: "dark",
      securityLevel: "loose",
      flowchart: { htmlLabels: true, useMaxWidth: false },
      themeVariables: {
        primaryColor: "#0b1224",
        primaryBorderColor: "#e92b2d",
        primaryTextColor: "#f8fafc",
        lineColor: "#e92b2d",
        secondaryColor: "#0f172a",
      },
    });
  }

  (function() {
    const modal = document.getElementById("diagram-modal");
    const titleEl = document.getElementById("diagram-modal-title");
    const viewer = document.getElementById("diagram-viewer");
    const viewerInner = document.getElementById("diagram-viewer-inner");
    const btnClose = document.getElementById("diagram-close");
    const btnIn = document.getElementById("zoom-in");
    const btnOut = document.getElementById("zoom-out");
    const btnReset = document.getElementById("zoom-reset");
    const btnFit = document.getElementById("zoom-fit");
    const zoomSlider = document.getElementById("zoom-slider");
    const zoomIndicator = document.getElementById("zoom-indicator");
    const openers = document.querySelectorAll(".diagram-open");

    // Zoom configuration
    const MIN_ZOOM = 0.2;
    const MAX_ZOOM = 3.0;
    const ZOOM_STEP = 0.15;
    const WHEEL_ZOOM_FACTOR = 0.03; // Much gentler wheel zoom

    let scale = 1;
    let translateX = 0;
    let translateY = 0;
    let isPanning = false;
    let startX = 0;
    let startY = 0;
    let lastPanTime = 0;

    function clamp(val, min, max) {
      return Math.min(Math.max(val, min), max);
    }

    function updateZoomIndicator() {
      const percent = Math.round(scale * 100);
      zoomIndicator.innerHTML = `Zoom: <strong>${percent}%</strong>`;
      zoomSlider.value = percent;
    }

    function applyTransform(smooth = true) {
      if (!smooth) {
        viewerInner.classList.add("no-transition");
      } else {
        viewerInner.classList.remove("no-transition");
      }
      viewerInner.style.transform = `translate(calc(-50% + ${translateX}px), calc(-50% + ${translateY}px)) scale(${scale})`;
      updateZoomIndicator();

      // Remove no-transition class after a frame
      if (!smooth) {
        requestAnimationFrame(() => {
          viewerInner.classList.remove("no-transition");
        });
      }
    }

    function setZoom(newScale, smooth = true) {
      scale = clamp(newScale, MIN_ZOOM, MAX_ZOOM);
      applyTransform(smooth);
    }

    function zoomToPoint(newScale, clientX, clientY, smooth = true) {
      // Get viewer bounds
      const rect = viewer.getBoundingClientRect();
      const viewerCenterX = rect.width / 2;
      const viewerCenterY = rect.height / 2;

      // Mouse position relative to viewer center
      const mouseX = clientX - rect.left - viewerCenterX;
      const mouseY = clientY - rect.top - viewerCenterY;

      // Calculate the point under the mouse in content coordinates
      const contentX = (mouseX - translateX) / scale;
      const contentY = (mouseY - translateY) / scale;

      // Apply new scale
      const oldScale = scale;
      scale = clamp(newScale, MIN_ZOOM, MAX_ZOOM);

      // Adjust translation so the point under the mouse stays in place
      translateX = mouseX - contentX * scale;
      translateY = mouseY - contentY * scale;

      applyTransform(smooth);
    }

    function resetView() {
      scale = 1;
      translateX = 0;
      translateY = 0;
      applyTransform(true);
    }

    function fitToView() {
      // Get the content size
      const content = viewerInner.firstElementChild;
      if (!content) return;

      const rect = viewer.getBoundingClientRect();
      const contentRect = content.getBoundingClientRect();

      // Calculate scale to fit with padding
      const padding = 40;
      const scaleX = (rect.width - padding * 2) / (contentRect.width / scale);
      const scaleY = (rect.height - padding * 2) / (contentRect.height / scale);
      const fitScale = Math.min(scaleX, scaleY, 1.5); // Cap at 150%

      scale = clamp(fitScale, MIN_ZOOM, MAX_ZOOM);
      translateX = 0;
      translateY = 0;
      applyTransform(true);
    }

    openers.forEach((btn) => {
      btn.addEventListener("click", () => {
        const targetId = btn.getAttribute("data-target");
        const title = btn.getAttribute("data-title") || "Diagram";
        const src = document.getElementById(targetId);
        if (!src) return;
        titleEl.textContent = title;
        viewerInner.innerHTML = src.innerHTML;
        resetView();
        modal.classList.add("active");

        // Auto-fit after a brief delay to let content render
        setTimeout(() => fitToView(), 100);
      });
    });

    btnClose.addEventListener("click", () => {
      modal.classList.remove("active");
    });

    btnIn.addEventListener("click", () => {
      setZoom(scale + ZOOM_STEP);
    });

    btnOut.addEventListener("click", () => {
      setZoom(scale - ZOOM_STEP);
    });

    btnReset.addEventListener("click", resetView);
    btnFit.addEventListener("click", fitToView);

    zoomSlider.addEventListener("input", (e) => {
      setZoom(parseInt(e.target.value) / 100, false);
    });

    // Wheel zoom - much gentler, zooms toward cursor
    viewer.addEventListener("wheel", (e) => {
      e.preventDefault();

      // Calculate zoom delta based on wheel movement
      const delta = -e.deltaY * WHEEL_ZOOM_FACTOR;
      const newScale = scale * (1 + delta);

      // Zoom toward cursor position
      zoomToPoint(newScale, e.clientX, e.clientY, false);
    }, { passive: false });

    // Panning with mouse
    viewer.addEventListener("mousedown", (e) => {
      if (e.button !== 0) return; // Only left click
      isPanning = true;
      startX = e.clientX;
      startY = e.clientY;
      viewerInner.classList.add("no-transition");
      viewer.style.cursor = "grabbing";
    });

    window.addEventListener("mousemove", (e) => {
      if (!isPanning) return;

      const dx = e.clientX - startX;
      const dy = e.clientY - startY;

      translateX += dx;
      translateY += dy;

      startX = e.clientX;
      startY = e.clientY;

      applyTransform(false);
    });

    window.addEventListener("mouseup", () => {
      if (isPanning) {
        isPanning = false;
        viewerInner.classList.remove("no-transition");
        viewer.style.cursor = "grab";
      }
    });

    // Double-click to reset
    viewer.addEventListener("dblclick", (e) => {
      e.preventDefault();
      resetView();
    });

    // Keyboard shortcuts when modal is open
    document.addEventListener("keydown", (e) => {
      if (!modal.classList.contains("active")) return;

      switch (e.key) {
        case "Escape":
          modal.classList.remove("active");
          break;
        case "+":
        case "=":
          e.preventDefault();
          setZoom(scale + ZOOM_STEP);
          break;
        case "-":
        case "_":
          e.preventDefault();
          setZoom(scale - ZOOM_STEP);
          break;
        case "0":
          e.preventDefault();
          resetView();
          break;
        case "f":
        case "F":
          e.preventDefault();
          fitToView();
          break;
      }
    });

    // Close on backdrop click
    modal.addEventListener("click", (e) => {
      if (e.target === modal) {
        modal.classList.remove("active");
      }
    });

    // Touch support for mobile
    let lastTouchDistance = 0;
    let lastTouchCenter = { x: 0, y: 0 };

    viewer.addEventListener("touchstart", (e) => {
      if (e.touches.length === 1) {
        isPanning = true;
        startX = e.touches[0].clientX;
        startY = e.touches[0].clientY;
        viewerInner.classList.add("no-transition");
      } else if (e.touches.length === 2) {
        isPanning = false;
        const dx = e.touches[1].clientX - e.touches[0].clientX;
        const dy = e.touches[1].clientY - e.touches[0].clientY;
        lastTouchDistance = Math.sqrt(dx * dx + dy * dy);
        lastTouchCenter = {
          x: (e.touches[0].clientX + e.touches[1].clientX) / 2,
          y: (e.touches[0].clientY + e.touches[1].clientY) / 2
        };
      }
    }, { passive: true });

    viewer.addEventListener("touchmove", (e) => {
      e.preventDefault();

      if (e.touches.length === 1 && isPanning) {
        const dx = e.touches[0].clientX - startX;
        const dy = e.touches[0].clientY - startY;
        translateX += dx;
        translateY += dy;
        startX = e.touches[0].clientX;
        startY = e.touches[0].clientY;
        applyTransform(false);
      } else if (e.touches.length === 2) {
        const dx = e.touches[1].clientX - e.touches[0].clientX;
        const dy = e.touches[1].clientY - e.touches[0].clientY;
        const distance = Math.sqrt(dx * dx + dy * dy);
        const center = {
          x: (e.touches[0].clientX + e.touches[1].clientX) / 2,
          y: (e.touches[0].clientY + e.touches[1].clientY) / 2
        };

        if (lastTouchDistance > 0) {
          const scaleFactor = distance / lastTouchDistance;
          zoomToPoint(scale * scaleFactor, center.x, center.y, false);
        }

        lastTouchDistance = distance;
        lastTouchCenter = center;
      }
    }, { passive: false });

    viewer.addEventListener("touchend", () => {
      isPanning = false;
      lastTouchDistance = 0;
      viewerInner.classList.remove("no-transition");
    }, { passive: true });
  })();
</script>
</html>
